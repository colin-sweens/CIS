***For example 
-- look at patient id = 50486779 using the query {{{SELECT diag.diagnosis_cd, count(cl.claim_id)
FROM enriched_iguana_staging.claim_diagnosis diag
INNER JOIN enriched_iguana_staging.claim_revenue_line cl
on diag.claim_id = cl.claim_id
WHERE cl.patient_id = 50486779
AND EXTRACT(YEAR FROM cl.claim_end_dt) IN (2017,2018,2019)
AND cl.hcpcs_cd IN('J9145')
GROUP By 1 ORDER by 2 DESC;}}}}


________________MAIN QUERY____For Patients___________________

-- Look at the Claim_line and Claim_Revenue_Line for the relevant HCPCS Codes. Get count of claims by patient by year
WITH 
L1_Diag_Table AS 
(SELECT hdr.patient_id, EXTRACT(YEAR FROM claim_end_dt) AS YEAR, count(distinct hdr.claim_id) as n_c9000_claims
FROM 
enriched_iguana_staging.claim_header hdr
INNER JOIN enriched_iguana_staging.claim_diagnosis diag
on diag.claim_id = hdr.claim_id
WHERE EXTRACT(YEAR FROM claim_end_dt) IN (2017,2018,2019)
 AND diag.diagnosis_cd IN('C9000')
GROUP by 1,2),

All_MM_Diag_Table AS 
(SELECT hdr.patient_id, EXTRACT(YEAR FROM claim_end_dt) AS YEAR, count(distinct hdr.claim_id) as n_MM_claims
FROM 
enriched_iguana_staging.claim_header hdr
INNER JOIN enriched_iguana_staging.claim_diagnosis diag
on diag.claim_id = hdr.claim_id
WHERE EXTRACT(YEAR FROM claim_end_dt) IN (2017,2018,2019)
 AND diag.diagnosis_cd LIKE'C90%'
GROUP by 1,2),

-- Look at the Claim_line and Claim_Revenue_Line for the relevant HCPCS Codes. Get count of claims by patient by year
Pt_Line_Items AS
(
SELECT patient_id, EXTRACT(YEAR FROM claim_end_dt) as YEAR, count(distinct claim_id) as n_line_claims
from
(SELECT hdr.patient_id, hdr.claim_id,hdr.claim_end_Dt
FROM enriched_iguana_staging.claim_header HDR
INNER JOIN enriched_iguana_staging.claim_revenue_line rev on hdr.claim_id = rev.claim_id
where rev.hcpcs_cd = 'J9145'
union ALL
SELECT hdr.patient_id, hdr.claim_id,hdr.claim_end_dt
FROM enriched_iguana_staging.claim_header HDR
INNER JOIN enriched_iguana_staging.claim_line lne on hdr.claim_id = lne.claim_id
where lne.hcpcs_cd = 'J9145'
)
WHERE EXTRACT(YEAR FROM claim_end_dt) IN(2017,2018,2019)
GROUP by 1,2),

-- Look at the RX Data for instances where Dara is listed with its NDC code. Get count of claims by patient by year
Pt_Rx_Items AS
(
SELECT patient_id, EXTRACT(YEAR FROM fill_dt) AS YEAR, count(distinct claim_id) as n_rx_claims
FROM enriched_iguana_staging.rx_claim
WHERE ndc_cd IN('57894050205','57894050220')
AND EXTRACT(YEAR FROM fill_dt) in(2017,2018,2019)
GROUP by 1,2)

-- JOIN CTEs
SELECT COALESCE(ptl.patient_id, ptrx.patient_id,dx.patient_id,MMDx.patient_id), COALESCE(ptl.YEAR,ptrx.YEAR,dx.year, MMDx.year), ptl.n_line_claims, ptrx.n_rx_claims,dx.n_c9000_claims,MMDx.n_MM_claims, (COALESCE(ptl.n_line_claims,0) + COALESCE(ptrx.n_rx_claims,0)) AS Total_Combined_Rx_and_Claim_Line_Claims
FROM
Pt_Line_Items ptl
FULL OUTER JOIN 
Pt_Rx_Items ptrx ON ptl.patient_id = ptrx.patient_id and ptl.year = ptrx.year
LEFT JOIN L1_Diag_Table Dx
ON ptl.patient_id = dx.patient_id and ptl.year = dx.year
LEFT JOIN All_MM_Diag_Table MMDx
ON ptl.patient_id = MMDx.patient_id and ptl.year = MMDx.year;







_____________________________________********MAIN QUERY FOR PHYSICIANS********__________________________
**To run in Refshift

-WITH 
PT_Line_Items AS(
SELECT npi, enumeration_type,attributed_name,specialty_clean,EXTRACT(YEAR FROM claim_end_dt) as YEAR, count(distinct patient_id) as n_line_patients,count(distinct claim_id) as n_line_claims
from
(SELECT ca.npi,
 prov.enumeration_type,prov.attributed_name,prov.specialty_clean,
 rev.patient_id,rev.claim_end_dt,rev.claim_id
FROM public.enriched_iguana_claim_revenue_line_20200205 rev
INNER JOIN public.enriched_iguana_claim_affiliate_20200205 ca on rev.claim_id = ca.claim_id
INNER JOIN public.clarify_provider prov on ca.npi = prov.npi
where rev.hcpcs_cd = 'J9145' 
 AND
 EXTRACT(YEAR FROM rev.claim_end_dt) IN(2017,2018,2019) 
union ALL
SELECT ca.npi,
  prov.enumeration_type,prov.attributed_name,prov.specialty_clean,
 lne.patient_id,lne.claim_end_dt, lne.claim_id
FROM public.enriched_iguana_claim_line_20200205 lne 
INNER JOIN public.enriched_iguana_claim_affiliate_20200205 ca on lne.claim_id = ca.claim_id
INNER JOIN public.clarify_provider prov on ca.npi = prov.npi
where lne.hcpcs_cd = 'J9145'
 AND
 EXTRACT(YEAR FROM lne.claim_end_dt) IN(2017,2018,2019) 
)
GROUP by 1,2,3,4,5),
--- providers with a C9000 diagnosis 
L1_Diag_Table AS 
(
(SELECT ca.npi, EXTRACT(YEAR FROM claim_end_dt) AS YEAR, count(distinct hdr.claim_id) as n_c9000_claims
FROM 
public.enriched_iguana_claim_header_20200205 hdr
INNER JOIN public.enriched_iguana_claim_diagnosis_20200205 diag
on diag.claim_id = hdr.claim_id
INNER JOIN public.enriched_iguana_claim_affiliate_20200205 ca 
on hdr.claim_id = ca.claim_id
WHERE EXTRACT(YEAR FROM hdr.claim_end_dt) IN (2017,2018,2019)
 AND diag.diagnosis_cd IN('C9000')
GROUP by 1,2)
),
--- providers with a difference MM diagnosis
All_MM_Diag_Table AS 
(SELECT ca.npi, EXTRACT(YEAR FROM claim_end_dt) AS YEAR, count(distinct hdr.claim_id) as n_MM_claims
FROM 
public.enriched_iguana_claim_header_20200205 hdr
INNER JOIN public.enriched_iguana_claim_diagnosis_20200205 diag
on diag.claim_id = hdr.claim_id
INNER JOIN public.enriched_iguana_claim_affiliate_20200205 ca 
on hdr.claim_id = ca.claim_id
WHERE EXTRACT(YEAR FROM hdr.claim_end_dt) IN (2017,2018,2019)
 AND diag.diagnosis_cd LIKE 'C90%'
GROUP by 1,2)
-- JOIN TABLES
SELECT COALESCE(ptl.npi,dx.npi,MMDx.npi)as NPI,ptl.enumeration_type, ptl.attributed_name,ptl.specialty_clean,COALESCE(ptl.YEAR,dx.year, MMDx.year)as "YEAR", ptl.n_line_claims,ptl.n_line_patients, dx.n_c9000_claims,MMDx.n_MM_claims
FROM
Pt_Line_Items ptl
-- FULL OUTER JOIN 
-- Pt_Rx_Items ptrx ON ptl.patient_id = ptrx.patient_id and ptl.year = ptrx.year
LEFT JOIN L1_Diag_Table Dx
ON ptl.npi = dx.npi and ptl.year = dx.year
LEFT JOIN All_MM_Diag_Table MMDx
ON ptl.npi = MMDx.npi and ptl.year = MMDx.year


___________________________**********MAIN QUERY FOR PLACE OF SERVICE*******************

*IN REDSHIFT


SELECT claim_category,EXTRACT(YEAR FROM claim_end_dt) as YEAR, count(distinct patient_id) n_pts,count(distinct claim_id) n_claims
FROM
(
SELECT hdr.claim_category,hdr.claim_category_cd,hdr.claim_category_subtype,rev.claim_revenue_center_cd,rev.patient_id,rev.claim_end_dt,rev.claim_id
FROM public.enriched_iguana_claim_revenue_line_20200205 rev
INNER JOIN public.enriched_iguana_claim_header_20200205 hdr on rev.claim_id = hdr.claim_id
where rev.hcpcs_cd = 'J9145' 
 AND
 EXTRACT(YEAR FROM rev.claim_end_dt) IN(2017,2018,2019)
union ALL
SELECT hdr.claim_category,hdr.claim_category_cd,hdr.claim_category_subtype,lne.claim_revenue_center_cd, lne.patient_id,lne.claim_end_dt,lne.claim_id
FROM public.enriched_iguana_claim_line_20200205 lne 
INNER JOIN public.enriched_iguana_claim_header_20200205 hdr on lne.claim_id = hdr.claim_id
where lne.hcpcs_cd = 'J9145'
 AND
 EXTRACT(YEAR FROM lne.claim_end_dt) IN(2017,2018,2019) 
)
GROUP by 1,2;

